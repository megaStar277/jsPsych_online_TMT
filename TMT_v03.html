<!DOCTYPE html>
<html>
<head>
    <script src="jspsych/jspsych.js"></script>
  
    <script src="jspsych/plugins/jspsych-call-function.js"></script>
    <script src="jspsych/plugins/jspsych-fullscreen.js"></script>   
    <script src="jspsych/plugins/jspsych-psychophysics_modified.js"></script>
    <script src="jspsych/plugins/jspsych-survey-html-form.js"></script>

    <script src="utils.js"></script>

    <link rel="stylesheet" href="C:\Users\Gustavo\Desktop\Tesis doctoral Juantorena\tmt_online/jspsych/css/jspsych.css"></link>
    
</head>
<body></body>
<script>
    
    // (x , y) coordinates of the mouse
    let x = 0;
    let y = 0; 
    isDrawing = false;

    // I put this to show fixation cross during this amount of time.
    var delayInMilliseconds = 1000; //1 second

    // All the images to present
    images = [ 
        'tmt_A_black.jpg','tmt_B_black.jpg'
        ];

    
    // store all images names in an array of objects {'fileName': images[imag]}
    let container = { }; // main object
    timelineVariables = [];    
       
    for (imag in images){
        timelineVariables.push(container['prop'+ imag ]   = { 'fileName': images[imag]}
        ); 
    } 

    // The blocks of the experiment 

    // Welcome
        var welcome_block = {
            data: {
                screen_id: "Bienvenidx"
            },
            type: "survey-html-form",
            preamble: "<p>Bienvenidx al experimento!</p>" +
                "Por favor completa los siguientes datos",
            // html: "<p>Participant ID: <input name='Part_ID' type='text' /></p>" 
            html: '<p> Nombre <input name="name" type="text" /></p> Edad <input name="age" type="text" /> </p> GÃ©nero <input name="gender" type="text" /></p> E-mail <input name="mail" type="text" /></p>'
            // on_finish: function(data) {
            //     responses = JSON.parse(data.responses);
            //     jsPsych.data.addProperties({
            //         part_ID: responses.Part_ID,
            //         ID_DATE: responses.Part_ID + "_" + DATE,
                // })
            }
        // };

    var extra_image = {
        obj_type: 'image',
        file: jsPsych.timelineVariable('fileName'),
        startX: 1100,// image position
        startY: 150,
        drawFunc: function(stimulus, canvas, context){
        setTimeout(function() { // putting a delay time to show the image
        context.drawImage(stimulus.img, 0, 0, stimulus.img.width, 
        stimulus.img.height, stimulus.currentX/2, stimulus.currentY/2, 
        stimulus.img.width/1.5 , stimulus.img.height/1.5);

        console.log(stimulus.img, 0, 0, 'img.width: ' + stimulus.img.width, 
        'img.height: ' + stimulus.img.height, 'img positition X: ' +stimulus.currentX/2, 'img positition Y: ' +stimulus.currentY/2, 
        'img.width: ' +stimulus.img.width/1.5 , 'img.height: ' +stimulus.img.height/1.5)
    }, delayInMilliseconds);
             
        }
    }

    var extra_cross = {
        obj_type: 'cross', // fixation
        line_length: 20, // pixels
        line_width: 4,
        // show_start_time: 500,
        drawFunc: function(stimulus, canvas, context){
            canvas.addEventListener('mousedown', e => {
       console.log('entro a mousedown');
      
        x = e.offsetX;
        y = e.offsetY;

        isDrawing = true;
      });  

     {
    
      context.beginPath();            
      context.lineWidth = stimulus.line_width;
      context.lineJoin = stimulus.lineJoin;
      context.miterLimit = stimulus.miterLimit;
      //
      context.strokeStyle = 'white';
      const x1 = stimulus.currentX;
      const y1 = stimulus.currentY - stimulus.line_length/2;
      const x2 = stimulus.currentX;
      const y2 = stimulus.currentY + stimulus.line_length/2;                
      context.moveTo(x1, y1);
      context.lineTo(x2, y2);
      const x3 = stimulus.currentX - stimulus.line_length/2;
      const y3 = stimulus.currentY;
      const x4 = stimulus.currentX + stimulus.line_length/2;
      const y4 = stimulus.currentY;                
      context.moveTo(x3, y3);
      context.lineTo(x4, y4);
      // ctx.closePath();
      context.stroke();
    }
        }
    }

    var fullScreen = {
        type: 'fullscreen',
        fullscreen_mode: true,
        message: '<p>El experimento ira a pantalla completa cuando usted presione el boton que se encuentra debajo</p>',
        button_label: 'Continuar a pantalla completa'    
    }    
    var text_object = {
      obj_type: 'text',
      content: 'Se le mostrara una pantalla con circulos.\n Tendra que unirlos en orden ascendente, por favor presione la barra espaciadora para continuar.',
      font: "24px 'Arial'",
      text_color: 'white',
      text_space: 100,
    }

    var instruction = {
        type: 'psychophysics',
        stimuli: [text_object],
        choices: ['space'],
    }

    var trial = {
        timeline: [
                
            {
                type: 'psychophysics',
                stimuli: [
                
                extra_cross,    
                extra_image,
                
                    
                    {
                        obj_type: 'image',
                        file: jsPsych.timelineVariable('fileNamxe'), // tngo que romper esto para que ande
                        //  show_start_time: 1000 // ms after the start of the trial //
                         
                    },
                    
                ],
                response_type: 'mouse',
                background_color: 'black',
                canvas_height: 850,
                canvas_width: 1600,
                // prompt: 'Press any key to proceed.'
                data: {'file_name': jsPsych.timelineVariable('fileName')} // for identification
            }
        ],
        timeline_variables: 
            
            timelineVariables

            // timelineVariables remmplace the previous format:

            // {fileName: images[0]},
            // {fileName: images[1]},
            // {fileName: images[2]}
        ,
        repetitions: 1,
        randomize_order: false
    }

    jsPsych.init({
        timeline: [welcome_block,fullScreen,instruction, trial],
        preload_images: images, // Image data should be preloaded
        on_finish: function()
        {jsPsych.data.displayData ();
        let json = jsPsych.data.get().json();
        let filename = 'tmt_data.json';
        
        downloadJSON(json, filename);
        
        }
    });
</script>

</html>