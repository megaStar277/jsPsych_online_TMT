<!DOCTYPE html>
<html>
<head>

    <!-- jQuery -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script src=" C:\Users\Gustavo\Desktop\librerias_virtualChin/jquery.min.js"></script> -->

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <!-- <script src="C:\Users\Gustavo\Desktop\librerias_virtualChin/jquery-ui.min.js"></script> -->

    <!-- css -->
    <link href="styles.css" rel="stylesheet" type="text/css">

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- <link href= "C:\Users\Gustavo\Desktop\librerias_virtualChin/bootstrap.min.css"> -->
 
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
    <!-- <link href="C:\Users\Gustavo\Desktop\librerias_virtualChin/jquery-ui.css" rel="stylesheet" type="text/css"> -->

    <link rel="stylesheet" href='jspsych/css/jspsych.css'> 

    <!-- SVG.js -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script>
    <!-- <script src=" C:\Users\Gustavo\Desktop\librerias_virtualChin/svg.min.js"></script> -->

    <!-- jsPsych library -->
    <script src="jspsych/jspsych.js"></script>

    <!-- jsPsych plugins-->
    <script src="jspsych/plugins/jspsych-call-function.js"></script>
    <script src="jspsych/plugins/jspsych-fullscreen.js"></script>   
    <script src="jspsych/plugins/jspsych-psychophysics_modified.js"></script>
    <script src="jspsych/plugins/jspsych-survey-html-form.js"></script>
    <script src= 'jspsych/plugins/jspsych-virtual-chin.js'></script>

    <script src="utils.js"></script>

    <!-- survey-html-form -->
    <!-- <link rel="stylesheet" href="C:\Users\Gustavo\Desktop\Tesis doctoral Juantorena\tmt_online/jspsych/css/jspsych.css"></link> -->
    
</head>
<body></body>
<script>

    // Mouse coordinates (x , y) 
    let x = 0;
    let y = 0; 
    isDrawing = false;

    // presentation time of the fixation cross
    var delayInMilliseconds = 1000; //1 second

    // All the images to present
    images = [ 
        'tmt_A_black.jpg','tmt_B_black.jpg'
        ];

    
    // store all images names in an array of objects {'fileName': images[imag]}
    let container = { }; // main object
    timelineVariables = [];    
       
    for (imag in images){
        timelineVariables.push(container['prop'+ imag ]   = { 'fileName': images[imag]}
        ); 
    } 

    // The blocks of the experiment 

    // Welcome
    var welcome_block = {
        data: {
            screen_id: "Bienvenidx"
        },
        type: "survey-html-form",
        preamble: "<p>¡Te damos la bienvenida al experimento!</p>" + "Por favor, completa los siguientes datos: </p> </p> ",
        
         html: `<p> Nombre <input name="name" type="text" /></p> Edad <input name="age" type="number" /> </p>
         Género <input list="gender" id="gender-choice" name="gender-choice" />
         <datalist id="gender"> <option value="MASCULINO"> <option value="FEMENINO"> <option value="OTRO"></datalist> </p>  
            E-mail <input name="mail" type="email" /> </p>`,

        button_label: "Continuar"
         };


    var extra_image = {
        obj_type: 'image',
        file: jsPsych.timelineVariable('fileName'),
        
        // show_start_time: 100,
        // horiz_pix_sec: 30,
        // show_start_time: 500,
        //  motion_start_time: 1000,
        startX: 1100,// image position
        startY: 150,
        drawFunc: function(stimulus, canvas, context){
        setTimeout(function() { // putting a delay time to show the image
        context.drawImage(stimulus.img, 0, 0, stimulus.img.width, 
        stimulus.img.height, stimulus.currentX/2, stimulus.currentY/2, 
        stimulus.img.width/1.5 , stimulus.img.height/1.5);
    }, delayInMilliseconds);
             
        }
    }

    var extra_cross = {
        obj_type: 'cross', // fixation
        line_length: 20, // pixels
        line_width: 4,
        // show_start_time: 500,
        drawFunc: function(stimulus, canvas, context){
            canvas.addEventListener('mousedown', e => {
       console.log('entro a mousedown');
      
        x = e.offsetX;
        y = e.offsetY;

        isDrawing = true;
      });  

            {
    
      context.beginPath();            
      context.lineWidth = stimulus.line_width;
      context.lineJoin = stimulus.lineJoin;
      context.miterLimit = stimulus.miterLimit;
      //
      context.strokeStyle = 'white';
      const x1 = stimulus.currentX;
      const y1 = stimulus.currentY - stimulus.line_length/2;
      const x2 = stimulus.currentX;
      const y2 = stimulus.currentY + stimulus.line_length/2;                
      context.moveTo(x1, y1);
      context.lineTo(x2, y2);
      const x3 = stimulus.currentX - stimulus.line_length/2;
      const y3 = stimulus.currentY;
      const x4 = stimulus.currentX + stimulus.line_length/2;
      const y4 = stimulus.currentY;                
      context.moveTo(x3, y3);
      context.lineTo(x4, y4);
      // ctx.closePath();
      context.stroke();
    }
        }
    }

    var fullScreen = {
        type: 'fullscreen',
        fullscreen_mode: true,
        message: '<p>El experimento ira a pantalla completa cuando usted presione el boton que se encuentra debajo</p>',
        button_label: 'Continuar a pantalla completa'    
    }    

    var chin = {
        type: 'virtual-chin'
    } 

    var text_object = {
      obj_type: 'text',
      content: 'Se le mostrara una pantalla con circulos.\n Tendra que unirlos en orden ascendente, por favor presione la barra espaciadora para continuar.',
      font: "24px 'Arial'",
      text_color: 'white',
      text_space: 100,
    }

    var instruction = {
        type: 'psychophysics',
        stimuli: [text_object],
        choices: ['space'],
    }

    var trial = {
        timeline: [
                
            {
                type: 'psychophysics',
                stimuli: [
                
                extra_cross,    
                extra_image,
                
                    
                    {
                        obj_type: 'image',
                        file: jsPsych.timelineVariable('fileNamxe'), // tngo que romper esto para que ande
                        //  show_start_time: 1000 // ms after the start of the trial //
                         
                    },
                    
                ],
                response_type: 'mouse',
                background_color: 'black',
                canvas_height: 850,
                canvas_width: 1600,
                // prompt: 'Press any key to proceed.'
                data: {'file_name': jsPsych.timelineVariable('fileName')} // for identification
            }
        ],
        timeline_variables: 
            
            timelineVariables

            // timelineVariables remmplace the previous format:

            // {fileName: images[0]},
            // {fileName: images[1]},
            // {fileName: images[2]}
        ,
        repetitions: 2,
        randomize_order: false
    }

    jsPsych.init({

        timeline: [welcome_block,fullScreen, chin, instruction, trial],
        // timeline: [chin],
        preload_images: images, // Image data should be preloaded
        on_finish: function()
        {jsPsych.data.displayData ();
        let json = jsPsych.data.get().json();
        let filename = 'tmt_data.json';
        
        downloadJSON(json, filename);
        
        }
        
        });
</script>

</html>
