<!DOCTYPE html>
<html>
<head>

    <!-- jQuery -->

    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
    <script src=" C:\Users\Gustavo\Desktop\librerias_virtualChin/jquery.min.js"></script>

    <!-- <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script> -->
    <script src="C:\Users\Gustavo\Desktop\librerias_virtualChin/jquery-ui.min.js"></script>

    <!-- virtual chin css -->
    <link href="C:\Users\Gustavo\Desktop\librerias_virtualChin\styles.css" rel="stylesheet" type="text/css">

    <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
    <link href= "C:\Users\Gustavo\Desktop\librerias_virtualChin/bootstrap.min.css">
 
    <!-- <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"> -->
    <link href="C:\Users\Gustavo\Desktop\librerias_virtualChin/jquery-ui.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href='C:\Users\Gustavo\Desktop\TMT_ONLINE_REPO\jsPsych_online_TMT\jspsych\css/jspsych.css'> 

    <!-- SVG.js -->

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script> -->
    <script src=" C:\Users\Gustavo\Desktop\librerias_virtualChin/svg.min.js"></script>

    <!-- jsPsych library -->
    <script src="jspsych/jspsych.js"></script>

    <!-- jsPsych plugins-->
    <script src="jspsych/plugins/jspsych-call-function.js"></script>
    <script src="jspsych/plugins/jspsych-fullscreen.js"></script>   
    <script src="jspsych/plugins/jspsych-psychophysics_modified.js"></script>
    <script src="jspsych/plugins/jspsych-survey-html-form.js"></script>
    <script src= 'jspsych/plugins/jspsych-virtual-chin-copy.js'></script>
    <script src="jspsych/plugins/jspsych-resize.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>   
    
    <!-- For local saving of the data in CSV format -->
    <script src="utils.js"></script> 
    
</head>
<body></body>
<script>

    // Mouse coordinates (x , y) 
    let x = 0;
    let y = 0; 
    isDrawing = false;

    // To avoid scroll down when press space bar
    window.onkeydown = function(e) {
    return e.keyCode !== 32;
    };

    // disable scrolling page
	function disableScroll() { 
			// Get the current page scroll position 
			scrollTop = 
			window.pageYOffset || document.documentElement.scrollTop; 
			scrollLeft = 
			window.pageXOffset || document.documentElement.scrollLeft, 

				// if any scroll is attempted, 
				// set this to the previous value 
				window.onscroll = function() { 
					window.scrollTo(scrollLeft, scrollTop); 
				}; 
		} 
        
    disableScroll(); 
  
        
 
    // presentation time of the fixation cross
    var delayInMilliseconds = 1000; // it´s an indirect way to control the momento of presentation of images

    // All the images to present
    // images = [ 
    //     'happy_face_4.jpg','tmt_642_480.jpg'
    //     ];

    images = [
        './stimulus/1.jpg', './stimulus/2.jpg', './stimulus/3.jpg', './stimulus/4.jpg', './stimulus/5.jpg',
        './stimulus/6.jpg', './stimulus/7.jpg', './stimulus/8.jpg', './stimulus/9.jpg', './stimulus/10.jpg',
        ];



    // store all images names in an array of objects {'fileName': images[imag]}
    let container = { }; // main object
    timelineVariables = [];    
       
    for (imag in images){
        // imag = 'stimuli/'+imag;
        timelineVariables.push(container['prop'+ imag ]   = { 'fileName': images[imag]}
        ); 
    } 

    // The blocks of the experiment 

    // Welcome
    var welcome_block = {
            data: {
                screen_id: "Bienvenidx"
            },
            type: "survey-html-form",
            preamble: "<p>¡Te damos la bienvenida al experimento!</p>" + "Por favor, completa los siguientes datos: </p> </p> ",

            html: 
                `<table>
                    <tr>
                    <td align="right">Edad:</td>
                    <td align="left"><input name="age" type="number" required="" /></td>
                    </tr>
                    <tr>
                    <td align="right">Género:</td>
                    <td align="left"><input list="gender" id="gender-choice" name="gender-choice" required="" /><datalist id="gender"> 
                    <option value="MASCULINO"> <option value="FEMENINO"> <option value="OTRO"></datalist></td>
                    </tr>
                    <tr>
                    <td align="right">Dispositivo de entrada:</td>
                    <td align="left"><input list="MouseOrPad" id="MouseOrPad-choice" name="MouseOrPad-choice" required="" /><datalist id="MouseOrPad"> 
                    <option value="Mouse">  <option value="pad de notebook"> <option value="otro"></datalist> </td>
                    </tr>
                    <tr>
                    <td align="right">Mano hábil:</td>
                    <td align="left"><input list="hand" id="hand-choice" name="hand-choice" required="" /><datalist id="hand"> 
                    <option value="izquierda">  <option value="derecha"> </datalist></td>
                    </tr>
                    <tr>
                    <td align="right">¿Dispositivo configurado para mano hábil?</td>
                    <td align="left"><input list="hand_config" id="hand_config-choice" name="hand_config-choice" required="" /><datalist id="hand_config"> 
                    <option value="si"> <option value="no"></datalist></td>
                    </tr>
                    <tr>
                    <td align="right">E-mail:</td>
                    <td align="left"><input name="mail" type="email" required="" /></td>
                    </tr>
                </table>`,

                button_label: "Continuar"
                };

    var showed_image = {
        obj_type: 'image',
        file: jsPsych.timelineVariable('fileName'),     
        //  show_start_time: 500,
        // horiz_pix_sec: 30,
        // show_start_time: 500,
        //  motion_start_time: 1000,
        // origin_center: false,
        startX: 'center',// image position
        startY: 'center',
        
        
        drawFunc: function (stimulus, canvas, context) { // 'This function enables to move objects horizontally and vertically'
            setTimeout(function () // putting a delay time to show the image

            {
                context.drawImage(stimulus.img, 0, 0, stimulus.img.width,  // Puede que aca este cambiando el tamanio del canvas
                    stimulus.img.height, document.getElementById('myCanvas').width / 2 - 512,
                    document.getElementById('myCanvas').height / 2 - 384,
                    stimulus.img.width, stimulus.img.height);

            }, delayInMilliseconds);

        }
    }

    var extra_cross = {
        obj_type: 'cross', // fixation
        line_length: 20, // pixels
        line_width: 4,

        drawFunc: function(stimulus, canvas, context){
            canvas.addEventListener('mousedown', e => {
            console.log('entro a mousedown');
      
        x = e.offsetX;
        y = e.offsetY;

        isDrawing = true;
      });  

    { 
      
      context.beginPath();            
      context.lineWidth = stimulus.line_width;
      context.lineJoin = stimulus.lineJoin;
      context.miterLimit = stimulus.miterLimit;
      //
      context.strokeStyle = 'white';
      const x1 = stimulus.currentX;
      const y1 = stimulus.currentY - stimulus.line_length/2;
      const x2 = stimulus.currentX;
      const y2 = stimulus.currentY + stimulus.line_length/2;                
      context.moveTo(x1, y1);
      context.lineTo(x2, y2);
      const x3 = stimulus.currentX - stimulus.line_length/2;
      const y3 = stimulus.currentY;
      const x4 = stimulus.currentX + stimulus.line_length/2;
      const y4 = stimulus.currentY;                
      context.moveTo(x3, y3);
      context.lineTo(x4, y4);
      // ctx.closePath();
      context.stroke();
    }
        }
    };

    var fullScreen = {
        type: 'fullscreen',
        fullscreen_mode: true,
        message: '<p>El experimento ira a pantalla completa cuando usted presione el boton que se encuentra debajo</p><br>',
        button_label: 'Continuar a pantalla completa'    
    } 
    
    var chin = {    
        type: 'virtual-chin'
    };

    var resize_trial = {
      type: 'resize',
      item_width: 3 + 3/8,
      item_height: 2 + 1/8,
    //   prompt: "<p>Click and drag the lower right corner of the box until the box is the same size as a credit card held up to the screen.</p>",
      prompt: `<p>Por favor coloque una tarjeta sobre la pantalla (puede ser crédito, débito, SUBE o cualquiera que tenga tamaño 
                estándar 8.56 x 5.4 cm),<br> luego haga click y deslice la esquina inferior derecha del recuadro azul hasta que 
                sean del mismo tamaño <br> Asegúrese de poner la tarjeta sobre la pantalla<br><br>
                Esto nos sirve para estimar el tamaño de su pantalla comparándolo con un objeto de tamaño conocido.</p>`,
      pixels_per_unit: 642/4, // Tendre que cambiar esto? el original es 642/4
      button_label: 'Continuar'
    };


    var text_object = {
      obj_type: 'text',
      content: 'Se le mostrara una pantalla con circulos.<br> Tendra que unirlos en orden ascendente, por favor presione la barra espaciadora para continuar.',
      font: "24px 'Arial'",
      text_color: 'white',
      text_space: 100,
    }

    var instruction = {
        type: 'psychophysics',
        stimuli: [text_object],
        choices: ['space'],
    }

    var trial = {
        timeline: [
                
            {
                type: 'psychophysics',
                stimuli: [
                
                extra_cross,    
                showed_image,
                
                    
                    {
                        obj_type: 'image',
                        file: jsPsych.timelineVariable('fileNamxe'), // tngo que romper esto para que ande
                        //  show_start_time: 1000 // ms after the start of the trial //
                         
                    },
                    
                ],
                response_type: 'mouse',
                background_color: 'black',
                // trial_duration: 5000, // after this amount of time, trial
                // canvas_height: 1850,
                // canvas_width: 2000,
                // prompt: 'Press any key to proceed.'
                data: {'file_name': jsPsych.timelineVariable('fileName')} // for identification
            }
        ],
        timeline_variables: 
            
            timelineVariables

            // timelineVariables remmplace the previous format:

            // {fileName: images[0]},
            // {fileName: images[1]},
            // {fileName: images[2]}
        ,
        repetitions: 1,
        randomize_order: false
    }



    var greetings = {
            type: "html-keyboard-response",
            stimulus: '<p style="font-size: 48px;">"El experimento terminó <br><br><br> ¡Muchas gracias por haber participado! <br><br><br>Presioná cualquier tecla para enviar los datos"</p>',
            // choices: jsPsych.NO_KEYS
        };

  
    jsPsych.init({
        
        timeline: [welcome_block,fullScreen,resize_trial, chin,instruction,trial,greetings],
        
        on_interaction_data_update: function(data) {
            // get the main trial data
            var trial = jsPsych.currentTrial();
            trial.data.screen_focus = data.event;
        },
        
        preload_images: images, // Image data should be preloaded
        on_finish: function(){
      
        jsPsych.data.displayData();
        let CSV = jsPsych.data.get().csv();
        let filename = 'tmt_data.csv'; // downloadJSON(json, filename)
        downloadCSV(CSV, filename);
        },
        
        exclusions: {       //minimum browser size values
            min_width: 800,
            min_height: 600
        }
 
        
        });
</script>

</html>
